/* Generated by JSIL v0.7.8 build 970. See http://jsil.org/ for more information. */ 
var $asm00 = JSIL.DeclareAssembly("Examples.SceneViewer, Version=0.1.0.0, Culture=neutral, PublicKeyToken=null");

JSIL.SetEntryPoint($asm00, $asm00.TypeRef("Examples.SceneViewer.SceneViewer"), "Main", new JSIL.MethodSignature(null, []));

JSIL.DeclareNamespace("Examples");
JSIL.DeclareNamespace("Examples.SceneViewer");
/* class Examples.SceneViewer.SceneViewer */ 

(function SceneViewer$Members () {
  var $, $thisType;
  var $T00 = function () {
    return ($T00 = JSIL.Memoize($asm02.Fusee.Engine.RenderCanvas)) ();
  };
  var $T01 = function () {
    return ($T01 = JSIL.Memoize($asm05.Fusee.Serialization.Serializer)) ();
  };
  var $T02 = function () {
    return ($T02 = JSIL.Memoize($asm06.System.IO.FileStream)) ();
  };
  var $T03 = function () {
    return ($T03 = JSIL.Memoize($asm06.System.IO.File)) ();
  };
  var $T04 = function () {
    return ($T04 = JSIL.Memoize($asm04.Fusee.Serialization.SceneContainer)) ();
  };
  var $T05 = function () {
    return ($T05 = JSIL.Memoize($asm07.ProtoBuf.Meta.TypeModel)) ();
  };
  var $T06 = function () {
    return ($T06 = JSIL.Memoize($asm06.System.IDisposable)) ();
  };
  var $T07 = function () {
    return ($T07 = JSIL.Memoize($asm00.Examples.SceneViewer.SceneRenderer)) ();
  };
  var $T08 = function () {
    return ($T08 = JSIL.Memoize($asm02.Fusee.Engine.MoreShaders)) ();
  };
  var $T09 = function () {
    return ($T09 = JSIL.Memoize($asm02.Fusee.Engine.ShaderProgram)) ();
  };
  var $T0A = function () {
    return ($T0A = JSIL.Memoize($asm02.Fusee.Engine.RenderContext)) ();
  };
  var $T0B = function () {
    return ($T0B = JSIL.Memoize($asm03.Fusee.Math.float4)) ();
  };
  var $T0C = function () {
    return ($T0C = JSIL.Memoize($asm01.Fusee.Engine.ClearFlags)) ();
  };
  var $T0D = function () {
    return ($T0D = JSIL.Memoize($asm02.Fusee.Engine.Input)) ();
  };
  var $T0E = function () {
    return ($T0E = JSIL.Memoize($asm01.Fusee.Engine.MouseButtons)) ();
  };
  var $T0F = function () {
    return ($T0F = JSIL.Memoize($asm01.Fusee.Engine.InputAxis)) ();
  };
  var $T10 = function () {
    return ($T10 = JSIL.Memoize($asm06.System.Single)) ();
  };
  var $T11 = function () {
    return ($T11 = JSIL.Memoize($asm06.System.Math)) ();
  };
  var $T12 = function () {
    return ($T12 = JSIL.Memoize($asm02.Fusee.Engine.Time)) ();
  };
  var $T13 = function () {
    return ($T13 = JSIL.Memoize($asm01.Fusee.Engine.KeyCodes)) ();
  };
  var $T14 = function () {
    return ($T14 = JSIL.Memoize($asm03.Fusee.Math.float4x4)) ();
  };
  var $T15 = function () {
    return ($T15 = JSIL.Memoize($asm02.Fusee.Engine.Diagnostics)) ();
  };
  var $T16 = function () {
    return ($T16 = JSIL.Memoize($asm06.System.Object)) ();
  };
  var $T17 = function () {
    return ($T17 = JSIL.Memoize($asm04.Fusee.Serialization.MeshContainer)) ();
  };
  var $T18 = function () {
    return ($T18 = JSIL.Memoize($asm03.Fusee.Math.float3)) ();
  };
  var $T19 = function () {
    return ($T19 = JSIL.Memoize($asm06.System.UInt16)) ();
  };
  var $T1A = function () {
    return ($T1A = JSIL.Memoize($asm04.Fusee.Serialization.SceneObjectContainer)) ();
  };
  var $T1B = function () {
    return ($T1B = JSIL.Memoize($asm04.Fusee.Serialization.SceneHeader)) ();
  };
  var $T1C = function () {
    return ($T1C = JSIL.Memoize($asm06.System.Collections.Generic.List$b1.Of($asm04.Fusee.Serialization.SceneObjectContainer))) ();
  };
  var $S00 = function () {
    return ($S00 = JSIL.Memoize(new JSIL.MethodSignature($asm06.TypeRef("System.Object"), [
        $asm06.TypeRef("System.IO.Stream"), $asm06.TypeRef("System.Object"), 
        $asm06.TypeRef("System.Type")
      ], []))) ();
  };
  var $S01 = function () {
    return ($S01 = JSIL.Memoize(new JSIL.ConstructorSignature($asm03.TypeRef("Fusee.Math.float4"), [
        $asm06.TypeRef("System.Single"), $asm06.TypeRef("System.Single"), 
        $asm06.TypeRef("System.Single"), $asm06.TypeRef("System.Single")
      ]))) ();
  };
  var $S02 = function () {
    return ($S02 = JSIL.Memoize(new JSIL.MethodSignature($asm03.TypeRef("Fusee.Math.float4x4"), [$asm03.TypeRef("Fusee.Math.float4x4"), $asm03.TypeRef("Fusee.Math.float4x4")], []))) ();
  };
  var $S03 = function () {
    return ($S03 = JSIL.Memoize(new JSIL.ConstructorSignature($asm03.TypeRef("Fusee.Math.float3"), [
        $asm06.TypeRef("System.Single"), $asm06.TypeRef("System.Single"), 
        $asm06.TypeRef("System.Single")
      ]))) ();
  };
  var $S04 = function () {
    return ($S04 = JSIL.Memoize(new JSIL.ConstructorSignature($asm06.TypeRef("System.Collections.Generic.List`1", [$asm04.TypeRef("Fusee.Serialization.SceneObjectContainer")]), [$asm06.TypeRef("System.Collections.Generic.IEnumerable`1", [$asm04.TypeRef("Fusee.Serialization.SceneObjectContainer")])]))) ();
  };
  var $S05 = function () {
    return ($S05 = JSIL.Memoize(new JSIL.MethodSignature(null, [$asm06.TypeRef("System.IO.Stream"), $asm06.TypeRef("System.Object")], []))) ();
  };
  var $IM00 = function () {
    return ($IM00 = JSIL.Memoize($asm06.System.IDisposable.Dispose)) ();
  };

  function SceneViewer__ctor () {
    $T00().prototype._ctor.call(this);
  };

  function SceneViewer_Init () {
    var ser = new ($T01())();
    var file = $T03().OpenRead("Assets/Model.fus");
    try {
      var scene = $T04().$As($S00().CallVirtual("Deserialize", null, ser, file, null, $T04().__Type__));
    } finally {
      if (file !== null) {
        $IM00().Call(file, null);
      }
    }
    this._sr = new ($T07())(scene);
    this._spColor = $T08().GetDiffuseColorShader(this.get_RC());
    this._colorParam = this._spColor.GetShaderParam("color");
    this.get_RC().SetShaderParam4f(this._colorParam, $S01().Construct(1, 1, 1, 1));
    (this.RenderCanvas$RC.ClearColor = $S01().Construct(1, 1, 1, 1));
  };

  function SceneViewer_Main () {
    var app = new $thisType();
    app.Run();
  };

  function SceneViewer_RenderAFrame () {
    this.get_RC().Clear($T0C().$Flags("Color", "Depth"));
    if ($T0D().get_Instance().IsButton($T0E().Left)) {
      $thisType._angleVelHorz = +(1 * $T0D().get_Instance().GetAxis($T0F().MouseX));
      $thisType._angleVelVert = +(1 * $T0D().get_Instance().GetAxis($T0F().MouseY));
    } else {
      var curDamp = +$T10().$Cast($T11().Exp((-0.92000001668930054 * $T12().get_Instance().get_DeltaTime())));
      $thisType._angleVelHorz *= +curDamp;
      $thisType._angleVelVert *= +curDamp;
    }
    $thisType._angleHorz -= +$thisType._angleVelHorz;
    $thisType._angleVert -= +$thisType._angleVelVert;
    if ($T0D().get_Instance().IsKey($T13().Left)) {
      $thisType._angleHorz -= +(1 * $T10().$Cast($T12().get_Instance().get_DeltaTime()));
    }
    if ($T0D().get_Instance().IsKey($T13().Right)) {
      $thisType._angleHorz += +(1 * $T10().$Cast($T12().get_Instance().get_DeltaTime()));
    }
    if ($T0D().get_Instance().IsKey($T13().Up)) {
      $thisType._angleVert -= +(1 * $T10().$Cast($T12().get_Instance().get_DeltaTime()));
    }
    if ($T0D().get_Instance().IsKey($T13().Down)) {
      $thisType._angleVert += +(1 * $T10().$Cast($T12().get_Instance().get_DeltaTime()));
    }
    var mtxRot = $S02().CallStatic($T14(), "op_Multiply", null, 
      $T14().CreateRotationX($thisType._angleVert), 
      $T14().CreateRotationY($thisType._angleHorz)
    );
    var mtxCam = $T14().LookAt(
      0, 
      200, 
      -500, 
      0, 
      0, 
      0, 
      0, 
      1, 
      0
    );
    (this.RenderCanvas$RC.ModelView = $S02().CallStatic($T14(), "op_Multiply", null, mtxCam, mtxRot).MemberwiseClone());
    this.get_RC().SetShader(this._spColor);
    this.get_RC().SetShaderParam4f(this._colorParam, $S01().Construct(0.5, 0.8, 0, 1));
    this._sr.Render(this.get_RC());
    this.Present();
  };

  function SceneViewer_Resize () {
    this.get_RC().Viewport(
      0, 
      0, 
      this.get_Width(), 
      this.get_Height()
    );
    var aspectRatio = +($T10().$Cast(this.get_Width()) / $T10().$Cast(this.get_Height()));
    (this.RenderCanvas$RC.Projection = $T14().CreatePerspectiveFieldOfView(0.7853982, aspectRatio, 1, 10000).MemberwiseClone());
  };

  function SceneViewer_TestDeserialize () {
    var ser = new ($T01())();
    var file = $T03().OpenRead("Assets/Test.fus");
    try {
      var mc2 = $T04().$As($S00().CallVirtual("Deserialize", null, ser, file, null, $T04().__Type__));
    } finally {
      if (file !== null) {
        $IM00().Call(file, null);
      }
    }
    $T15().Log(mc2.toString());
  };

  function SceneViewer_TestSerialize () {
    var aMesh = (new ($T17())()).__Initialize__({
        Vertices: JSIL.Array.New($T18(), [$S03().Construct(-1, -1, -1), $S03().Construct(-1, -1, 1), $S03().Construct(-1, 1, -1), $S03().Construct(1, -1, -1), $S03().Construct(1, 1, 1), $S03().Construct(-1, 1, 1), $S03().Construct(1, -1, 1), $S03().Construct(1, 1, -1)]), 
        Normals: JSIL.Array.New($T18(), [$S03().Construct(-1, -1, -1), $S03().Construct(-1, -1, 1), $S03().Construct(-1, 1, -1), $S03().Construct(1, -1, -1), $S03().Construct(1, 1, 1), $S03().Construct(-1, 1, 1), $S03().Construct(1, -1, 1), $S03().Construct(1, 1, -1)]), 
        Triangles: JSIL.Array.New($T19(), [0, 1, 2, 0, 2, 3, 0, 3, 1, 4, 5, 6, 4, 6, 7, 4, 7, 5])}
    );
    var aChild = (new ($T1A())()).__Initialize__({
        Mesh: aMesh, 
        Transform: $T14().CreateTranslation(0.11, 0.11, 0).MemberwiseClone()}
    );
    var parent = (new ($T04())()).__Initialize__({
        Header: (new ($T1B())()).__Initialize__({
            Version: 1, 
            Generator: "Fusee.SceneViewer", 
            CreatedBy: "FuseeProjetTeam"}
        ), 
        Children: $S04().Construct(JSIL.Array.New($T1A(), [aChild, aChild, (new ($T1A())()).__Initialize__({
                Mesh: aMesh, 
                Transform: $T14().CreateTranslation(0.22, 0.22, 0).MemberwiseClone()}
            )]))}
    );
    var ser = new ($T01())();
    var file = $T03().Create("Assets/Test.fus");
    try {
      $S05().CallVirtual("Serialize", null, ser, file, parent);
    } finally {
      if (file !== null) {
        $IM00().Call(file, null);
      }
    }
  };

  JSIL.MakeType({
      BaseType: $asm02.TypeRef("Fusee.Engine.RenderCanvas"), 
      Name: "Examples.SceneViewer.SceneViewer", 
      IsPublic: true, 
      IsReferenceType: true, 
      MaximumConstructorArguments: 0, 
    }, function ($interfaceBuilder) {
    $ = $interfaceBuilder;

    $.Method({Static:false, Public:true }, ".ctor", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer__ctor
    );

    $.Method({Static:false, Public:true , Virtual:true }, "Init", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer_Init
    );

    $.Method({Static:true , Public:true }, "Main", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer_Main
    );

    $.Method({Static:false, Public:true , Virtual:true }, "RenderAFrame", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer_RenderAFrame
    );

    $.Method({Static:false, Public:true , Virtual:true }, "Resize", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer_Resize
    );

    $.Method({Static:false, Public:false}, "TestDeserialize", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer_TestDeserialize
    );

    $.Method({Static:false, Public:false}, "TestSerialize", 
      new JSIL.MethodSignature(null, [], []), 
      SceneViewer_TestSerialize
    );

    $.Constant({Static:true , Public:false}, "RotationSpeed", 1); 
    $.Constant({Static:true , Public:false}, "Damping", 0.92); 
    $.Field({Static:true , Public:false}, "_angleHorz", $.Single); 
    $.Field({Static:true , Public:false}, "_angleVert", $.Single); 
    $.Field({Static:true , Public:false}, "_angleVelHorz", $.Single); 
    $.Field({Static:true , Public:false}, "_angleVelVert", $.Single); 
    $.Field({Static:false, Public:false}, "_meshFace", $asm02.TypeRef("Fusee.Engine.Mesh")); 
    $.Field({Static:false, Public:false}, "_meshTea", $asm02.TypeRef("Fusee.Engine.Mesh")); 
    $.Field({Static:false, Public:false}, "_sr", $asm00.TypeRef("Examples.SceneViewer.SceneRenderer")); 
    $.Field({Static:false, Public:false}, "_spColor", $asm02.TypeRef("Fusee.Engine.ShaderProgram")); 
    $.Field({Static:false, Public:false}, "_colorParam", $asm01.TypeRef("Fusee.Engine.IShaderParam")); 
    return function (newThisType) { $thisType = newThisType; }; 
  });

})();

/* class Examples.SceneViewer.SceneRenderer */ 

(function SceneRenderer$Members () {
  var $, $thisType;
  var $T00 = function () {
    return ($T00 = JSIL.Memoize($asm04.Fusee.Serialization.SceneContainer)) ();
  };
  var $T01 = function () {
    return ($T01 = JSIL.Memoize($asm06.System.Collections.Generic.Dictionary$b2.Of($asm04.Fusee.Serialization.MeshContainer, $asm02.Fusee.Engine.Mesh))) ();
  };
  var $T02 = function () {
    return ($T02 = JSIL.Memoize($asm04.Fusee.Serialization.SceneObjectContainer)) ();
  };
  var $T03 = function () {
    return ($T03 = JSIL.Memoize($asm02.Fusee.Engine.Mesh)) ();
  };
  var $T04 = function () {
    return ($T04 = JSIL.Memoize($asm02.Fusee.Engine.RenderContext)) ();
  };
  var $T05 = function () {
    return ($T05 = JSIL.Memoize($asm03.Fusee.Math.float3)) ();
  };
  var $T06 = function () {
    return ($T06 = JSIL.Memoize($asm02.Fusee.Engine.MoreShaders)) ();
  };
  var $T07 = function () {
    return ($T07 = JSIL.Memoize($asm02.Fusee.Engine.ShaderProgram)) ();
  };
  var $T08 = function () {
    return ($T08 = JSIL.Memoize($asm03.Fusee.Math.float4)) ();
  };
  var $T09 = function () {
    return ($T09 = JSIL.Memoize($asm03.Fusee.Math.float4x4)) ();
  };
  var $S00 = function () {
    return ($S00 = JSIL.Memoize(new JSIL.ConstructorSignature($asm06.TypeRef("System.Collections.Generic.Dictionary`2", [$asm04.TypeRef("Fusee.Serialization.MeshContainer"), $asm02.TypeRef("Fusee.Engine.Mesh")]), []))) ();
  };
  var $S01 = function () {
    return ($S01 = JSIL.Memoize(new JSIL.ConstructorSignature($asm03.TypeRef("Fusee.Math.float3"), [
        $asm06.TypeRef("System.Single"), $asm06.TypeRef("System.Single"), 
        $asm06.TypeRef("System.Single")
      ]))) ();
  };
  var $S02 = function () {
    return ($S02 = JSIL.Memoize(new JSIL.ConstructorSignature($asm03.TypeRef("Fusee.Math.float4"), [
        $asm06.TypeRef("System.Single"), $asm06.TypeRef("System.Single"), 
        $asm06.TypeRef("System.Single"), $asm06.TypeRef("System.Single")
      ]))) ();
  };
  var $S03 = function () {
    return ($S03 = JSIL.Memoize(new JSIL.MethodSignature($asm03.TypeRef("Fusee.Math.float4x4"), [$asm03.TypeRef("Fusee.Math.float4x4"), $asm03.TypeRef("Fusee.Math.float4x4")], []))) ();
  };

  function SceneRenderer__ctor (sc) {
    this._sc = sc;
    this._meshMap = $S00().Construct();
  };

  function SceneRenderer_get_CurCol () {
    return this._curCol;
  };

  function SceneRenderer_MakeMesh (soc) {
    return (new ($T03())()).__Initialize__({
        Colors: null, 
        Normals: soc.Mesh.Normals, 
        UVs: soc.Mesh.UVs, 
        Vertices: soc.Mesh.Vertices, 
        Triangles: soc.Mesh.Triangles}
    );
  };

  function SceneRenderer_Render (rc) {
    var $temp00;
    if (rc !== this._rc) {
      this._rc = rc;
      this._shader = null;
      this._colorParam = null;
      this._curCol = $S01().Construct(0.5, 0.5, 0.5);
    }
    if (this._shader === null) {
      this._shader = $T06().GetDiffuseColorShader(rc);
      this._colorParam = this._shader.GetShaderParam("color");
    }
    rc.SetShader(this._shader);

    for (var a$0 = this._sc.Children._items, i$0 = 0, l$0 = this._sc.Children._size; i$0 < l$0; ($temp00 = i$0, 
        i$0 = ((i$0 + 1) | 0), 
        $temp00)) {
      var soc = a$0[i$0];
      this.VisitNode(soc);
    }
  };

  function SceneRenderer_set_CurCol (value) {
    if (this._rc !== null) {
      this._rc.SetShaderParam4f(this._colorParam, $S02().Construct(value.x, value.y, value.z, 1));
    }
    this._curCol = value.MemberwiseClone();
  };

  function SceneRenderer_VisitNode (soc) {
    var $temp00;
    var rm = new JSIL.BoxedVariable(null);
    var origMV = this._rc.get_ModelView().MemberwiseClone();
    var origCol = this.get_CurCol().MemberwiseClone();
    if (soc.Material !== null) {
      (this.CurCol = soc.Material.DiffuseColor.MemberwiseClone());
    }
    (this._rc.ModelView = $S03().CallStatic($T09(), "op_Multiply", null, this._rc.ModelView, soc.Transform).MemberwiseClone());
    if (soc.Mesh !== null) {
      if (!this._meshMap.TryGetValue(soc.Mesh, /* ref */ rm)) {
        rm.set($thisType.MakeMesh(soc));
        this._meshMap.Add(soc.Mesh, rm.get());
      }
      this._rc.Render(rm.get());
    }
    if (soc.Children !== null) {

      for (var a$0 = soc.Children._items, i$0 = 0, l$0 = soc.Children._size; i$0 < l$0; ($temp00 = i$0, 
          i$0 = ((i$0 + 1) | 0), 
          $temp00)) {
        var child = a$0[i$0];
        this.VisitNode(child);
      }
    }
    (this._rc.ModelView = origMV.MemberwiseClone());
    (this.CurCol = origCol.MemberwiseClone());
  };

  JSIL.MakeType({
      BaseType: $asm06.TypeRef("System.Object"), 
      Name: "Examples.SceneViewer.SceneRenderer", 
      IsPublic: true, 
      IsReferenceType: true, 
      MaximumConstructorArguments: 1, 
    }, function ($interfaceBuilder) {
    $ = $interfaceBuilder;

    $.Method({Static:false, Public:true }, ".ctor", 
      new JSIL.MethodSignature(null, [$asm04.TypeRef("Fusee.Serialization.SceneContainer")], []), 
      SceneRenderer__ctor
    );

    $.Method({Static:false, Public:false}, "get_CurCol", 
      new JSIL.MethodSignature($asm03.TypeRef("Fusee.Math.float3"), [], []), 
      SceneRenderer_get_CurCol
    );

    $.Method({Static:true , Public:false}, "MakeMesh", 
      new JSIL.MethodSignature($asm02.TypeRef("Fusee.Engine.Mesh"), [$asm04.TypeRef("Fusee.Serialization.SceneObjectContainer")], []), 
      SceneRenderer_MakeMesh
    );

    $.Method({Static:false, Public:true }, "Render", 
      new JSIL.MethodSignature(null, [$asm02.TypeRef("Fusee.Engine.RenderContext")], []), 
      SceneRenderer_Render
    );

    $.Method({Static:false, Public:false}, "set_CurCol", 
      new JSIL.MethodSignature(null, [$asm03.TypeRef("Fusee.Math.float3")], []), 
      SceneRenderer_set_CurCol
    );

    $.Method({Static:false, Public:false}, "VisitNode", 
      new JSIL.MethodSignature(null, [$asm04.TypeRef("Fusee.Serialization.SceneObjectContainer")], []), 
      SceneRenderer_VisitNode
    );

    $.Field({Static:false, Public:false}, "_meshMap", $asm06.TypeRef("System.Collections.Generic.Dictionary`2", [$asm04.TypeRef("Fusee.Serialization.MeshContainer"), $asm02.TypeRef("Fusee.Engine.Mesh")])); 
    $.Field({Static:false, Public:false}, "_sc", $asm04.TypeRef("Fusee.Serialization.SceneContainer")); 
    $.Field({Static:false, Public:false}, "_rc", $asm02.TypeRef("Fusee.Engine.RenderContext")); 
    $.Field({Static:false, Public:false}, "_shader", $asm02.TypeRef("Fusee.Engine.ShaderProgram")); 
    $.Field({Static:false, Public:false}, "_colorParam", $asm01.TypeRef("Fusee.Engine.IShaderParam")); 
    $.Field({Static:false, Public:false}, "_curCol", $asm03.TypeRef("Fusee.Math.float3")); 
    $.Property({Static:false, Public:false}, "CurCol", $asm03.TypeRef("Fusee.Math.float3"));

    return function (newThisType) { $thisType = newThisType; }; 
  });

})();

